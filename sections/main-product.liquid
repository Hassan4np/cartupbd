<!-- sections/product-template.liquid -->
<div class="mx-auto py-10 lg:py-14 xl:py-20 2xl:py-25">
  <div class="max-w-250 mx-auto font-poppins">
    <div class="flex items-start gap-5 lg:gap-10">
      <!-- Left Column - Product Images -->
      <div class="space-y-2 lg:space-y-4">
        <div class="relative border border-gray-300 rounded-lg overflow-hidden">
          <img
            id="mainImage"
            src="{{ product.featured_image | img_url: '800x800' }}"
            alt="{{ product.title }}"
            class="w-100 h-full object-contain transition-transform duration-300"
            width="800"
            height="800" />
          {% if product.compare_at_price > product.price %}
            <div class="absolute top-4 right-4 bg-primary text-white px-3 py-1 rounded-full text-sm font-semibold">
              Sale
            </div>
          {% endif %}
        </div>

        <!-- Thumbnail Images -->
        <div class="flex gap-3 overflow-x-auto pb-2">
          {% for image in product.images limit: 5 %}
            <button
              onclick="changeMainImage('{{ image | img_url: '800x800' }}', {{ forloop.index0 }})"
              class="thumbnail-btn flex-shrink-0 size-15 lg:size-20 rounded-xl overflow-hidden border transition-all border-border"
              data-index="{{ forloop.index0 }}">
              <img
                src="{{ image | img_url: '200x200' }}"
                alt="{{ product.title }} - Image {{ forloop.index }}"
                width="200"
                height="200"
                class="w-full h-full object-cover" />
            </button>
          {% endfor %}
        </div>
      </div>
      <!-- Right Column - Product Info -->
      <div>
        <div>
          <h1 class="text-xl lg:text-2xl font-bold text-gray-900 mb-3 lg:mb-4">
            {{ product.title }}
          </h1>

          <!-- Short Description -->
          <p class="short-des text-sm md:text-base text-gray-600 mb-4">
            {% if product.metafields.custom.short_des %}
              {{ product.metafields.custom.short_des | metafield_tag }}
            {% else %}
              {{ product.description | strip_html | truncatewords: 20 }}
            {% endif %}
          </p>
        </div>

        <!-- Rating -->
        {% if product.metafields.reviews.rating %}
          <div class="flex items-center gap-3 mb-4">
            <div class="flex gap-1">
              {% for i in (1..5) %}
                <svg class="w-5 h-5 fill-orange-400 text-orange-400" viewBox="0 0 24 24">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                </svg>
              {% endfor %}
            </div>
            <span class="text-gray-600">
              ({{ product.metafields.reviews.count | default: 75 }} Reviews)
            </span>
          </div>
        {% endif %}

        <!-- Category and Items -->
        <div class="mb-4 space-y-2 mt-3">
          <p class="category text-base md:text-lg text-gray-900 leading-none">
            Category:
            <span class="text-gray-600 font-normal">
              {% if product.collections.size > 0 %}
                {{ product.collections.first.title }}
              {% elsif product.type != blank %}
                {{ product.type }}
              {% else %}
                Uncategorized
              {% endif %}
            </span>
          </p>

          <p class="category text-base md:text-lg text-gray-900 leading-none">
            Items:
            <span class="text-gray-600 font-normal">
              {% if product.metafields.custom.items_count %}
                {{ product.metafields.custom.items_count }}
              {% else %}
                {{ product.variants.size }}
              {% endif %}
            </span>
          </p>
        </div>

        <!-- Price -->
        <div class="flex items-baseline gap-3 mb-4">
          <span class="text-xl lg:text-2xl font-poppins font-semibold text-green-600">
            {{ product.selected_or_first_available_variant.price | money }}
          </span>
          {% if product.compare_at_price > product.price %}
            <span class="text-sm md:text-base text-gray-500 line-through">
              {{ product.selected_or_first_available_variant.compare_at_price | money }}
            </span>
          {% endif %}
        </div>

        <!-- Product Form -->
        {% form 'product'
          , product
          , id: 'product-form'
          , class: 'product-form' %}
          <input
            type="hidden"
            name="id"
            value="{{ product.selected_or_first_available_variant.id }}"
            id="product-variant-id">

          <!-- Variant Selection (if product has variants) -->
          {% unless product.has_only_default_variant %}
            <div class="mb-4">
              <label class="text-sm font-semibold text-gray-700 mb-2 block">Select Option:</label>
              <div class="flex flex-wrap gap-2">
                {% for variant in product.variants %}
                  <label class="relative cursor-pointer">
                    <input
                      type="radio"
                      name="variant-selector"
                      value="{{ variant.id }}"
                      class="peer hidden variant-radio"
                      data-price="{{ variant.price | money }}"
                      data-compare-price="{{ variant.compare_at_price | money }}"
                      {% if variant == product.selected_or_first_available_variant %}
                      checked{% endif %}
                      {% unless variant.available %}
                      disabled{% endunless %}
                      onchange="updateVariant(this)">
                    <span class="block px-4 py-2 rounded-lg border-2 font-medium transition-all
                      border-gray-300 text-gray-700 peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700
                      peer-disabled:opacity-50 peer-disabled:cursor-not-allowed hover:border-gray-400">
                      {{ variant.title }}
                    </span>
                  </label>
                {% endfor %}
              </div>
            </div>
          {% endunless %}

          <!-- Quantity and Actions -->
          <div class="flex flex-wrap gap-4 mt-3 lg:mt-4">
            <div class="flex items-center border border-gray-300 rounded-lg overflow-hidden">
              <button
                type="button"
                onclick="changeQuantity(-1)"
                class="px-3 py-2 hover:bg-gray-100 transition-colors">
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M20 12H4" />
                </svg>
              </button>
              <input
                type="number"
                id="quantity"
                name="quantity"
                value="1"
                min="1"
                class="w-12 px-2 py-2 text-center font-semibold border-0 focus:outline-none"
                readonly />
              <button
                type="button"
                onclick="changeQuantity(1)"
                class="px-3 py-2 hover:bg-gray-100 transition-colors">
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4v16m8-8H4" />
                </svg>
              </button>
            </div>

            <button
              type="button"
              name="add"
              id="addToCart"
              class="btn">
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
              <span id="addToCartText">Add Cart</span>
            </button>

            <button
              type="button"
              onclick="toggleWishlist()"
              id="wishlistBtn"
              class="p-2 border-2 border-gray-300 text-gray-600 rounded-lg hover:border-gray-400 transition-all">
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
              </svg>
            </button>

            <button
              type="button"
              onclick="shareProduct()"
              class="p-2 border-2 border-gray-300 text-gray-600 rounded-lg hover:border-gray-400 transition-colors">
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
              </svg>
            </button>
          </div>
        {% endform %}
      </div>
    </div>
    <!-- Tabs Section -->
    <div class="border-t border-gray-200">
      <div class="flex gap-8 px-8 border-b border-gray-200">
        <button
          onclick="switchTab('description')"
          class="tab-btn py-4 font-semibold capitalize transition-colors relative text-primary cursor-pointer"
          data-tab="description">
          Description
          <div class="absolute bottom-0 left-0 right-0 h-0.5 bg-primary tab-indicator"></div>
        </button>
        <button
          onclick="switchTab('reviews')"
          class="tab-btn py-4 font-semibold capitalize transition-colors relative text-gray-600 hover:text-gray-900 cursor-pointer"
          data-tab="reviews">
          Reviews
        </button>
      </div>

      <div class="p-8">
        <!-- Description Tab -->
        <div id="tab-description" class="tab-content">
          <p>
            {{ product.description }}
            {% if product.metafields.custom.packaging_info %}
              <h3 class="text-xl font-bold text-gray-900 mt-6 mb-3">
                Packaging & Delivery
              </h3>
              <p>{{ product.metafields.custom.packaging_info }}</p>
            {% endif %}
          </p>
        </div>

        <!-- Reviews Tab -->
      <div id="tab-reviews" class="tab-content hidden">
  <div class="text-gray-600">
    
    {% if product.metafields.reviews.rating.value %}
      <!-- Native Shopify Reviews -->
      <div class="product-reviews">
        <div class="rating-summary mb-4">
          <span class="text-2xl font-bold">{{ product.metafields.reviews.rating.value }}</span>
          <span class="text-gray-500">/ 5</span>
          <span class="text-sm text-gray-600 ml-2">
            ({{ product.metafields.reviews.rating_count }} reviews)
          </span>
        </div>
        
        <!-- Review form link -->
        <a href="#write-review" class="btn btn-primary mb-6">
          Review Likhen
        </a>
        
        <!-- Reviews list would go here -->
      </div>
    {% else %}
      <p class="text-center py-8">No reviews yet. Be the first!</p>
    {% endif %}
    
  </div>
</div>
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
  'use strict';
  
  // Image Gallery
  let currentImageIndex = 0;

  function changeMainImage(imageUrl, index) {
    const mainImg = document.getElementById('mainImage');
    if (mainImg) {
      mainImg.src = imageUrl;
      currentImageIndex = index;
      
      // Update active thumbnail
      document.querySelectorAll('.thumbnail-btn').forEach(function(btn, idx) {
        if (idx === index) {
          btn.classList.remove('border-gray-200');
          btn.classList.add('border-green-500', 'shadow-lg', 'scale-105');
        } else {
          btn.classList.remove('border-green-500', 'shadow-lg', 'scale-105');
          btn.classList.add('border-gray-200');
        }
      });
    }
  }

  // Quantity Controls
  function changeQuantity(change) {
    const quantityInput = document.getElementById('quantity');
    if (!quantityInput) return;
    
    let currentValue = parseInt(quantityInput.value) || 1;
    let newValue = currentValue + change;
    
    if (newValue >= 1) {
      quantityInput.value = newValue;
      quantityInput.dispatchEvent(new Event('input', { bubbles: true }));
    }
  }

  // Update Variant
  function updateVariant(radio) {
    if (!radio) return;
    
    const variantId = radio.value;
    const price = radio.getAttribute('data-price');
    const comparePrice = radio.getAttribute('data-compare-price');
    
    // Update hidden input
    const variantInput = document.getElementById('product-variant-id');
    if (variantInput) {
      variantInput.value = variantId;
    }
    
    // Update displayed price
    const priceElement = document.querySelector('.text-green-600');
    if (priceElement && price) {
      priceElement.textContent = price;
    }
    
    // Update compare price if exists
    const comparePriceElement = document.querySelector('.line-through');
    if (comparePriceElement) {
      if (comparePrice && comparePrice !== 'null' && comparePrice !== '') {
        comparePriceElement.textContent = comparePrice;
        comparePriceElement.style.display = 'inline';
      } else {
        comparePriceElement.style.display = 'none';
      }
    }
  }

  // Add to Cart Function
  function addToCart(event) {
    if (event) {
      event.preventDefault();
      event.stopPropagation();
    }
    
    const addButton = document.getElementById('addToCart');
    const buttonText = document.getElementById('addToCartText');
    const variantIdInput = document.getElementById('product-variant-id');
    const quantityInput = document.getElementById('quantity');
    
    if (!addButton || !buttonText || !variantIdInput || !quantityInput) {
      console.error('Required elements not found');
      return;
    }
    
    const variantId = variantIdInput.value;
    const quantity = parseInt(quantityInput.value) || 1;
    
    // Validate variant ID
    if (!variantId || variantId === '') {
      showNotification('Please select a product variant', 'error');
      return;
    }
    
    // Disable button and show loading state
    addButton.disabled = true;
    buttonText.textContent = 'Adding...';
    addButton.classList.add('opacity-75');
    
    // Prepare form data
    const formData = {
      items: [{
        id: variantId,
        quantity: quantity
      }]
    };
    
    console.log('Adding to cart:', formData);
    
    // Send AJAX request to Shopify cart
    fetch('/cart/add.js', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(formData)
    })
    .then(function(response) {
      if (!response.ok) {
        throw new Error('Network response was not ok: ' + response.status);
      }
      return response.json();
    })
    .then(function(data) {
      console.log('Successfully added to cart:', data);
      
      // Success - show success message
      buttonText.textContent = 'Added!';
      addButton.classList.remove('bg-green-500');
      addButton.classList.add('bg-green-600');
      
      // Update cart count
      updateCartCount();
      
      // Show success notification
      showNotification(quantity + ' item(s) added to cart!', 'success');
      
      // Reset quantity to 1
      quantityInput.value = 1;
      
      // Reset button after 2 seconds
      setTimeout(function() {
        addButton.disabled = false;
        buttonText.textContent = 'Add Cart';
        addButton.classList.remove('bg-green-600', 'opacity-75');
        addButton.classList.add('bg-green-500');
      }, 2000);
    })
    .catch(function(error) {
      // Error handling
      console.error('Error adding to cart:', error);
      buttonText.textContent = 'Error!';
      addButton.classList.remove('bg-green-500');
      addButton.classList.add('bg-red-500');
      
      showNotification('Failed to add product to cart. Please try again.', 'error');
      
      // Reset button after 2 seconds
      setTimeout(function() {
        addButton.disabled = false;
        buttonText.textContent = 'Add Cart';
        addButton.classList.remove('bg-red-500', 'opacity-75');
        addButton.classList.add('bg-green-500');
      }, 2000);
    });
  }

  // Update Cart Count
  function updateCartCount() {
    fetch('/cart.js')
      .then(function(response) { return response.json(); })
      .then(function(cart) {
        console.log('Cart updated:', cart);
        
        // Update all possible cart count elements
        const cartCountSelectors = [
          '.cart-count',
          '.cart-badge',
          '#cart-count',
          '[data-cart-count]',
          '.cart-item-count'
        ];
        
        cartCountSelectors.forEach(function(selector) {
          const elements = document.querySelectorAll(selector);
          elements.forEach(function(el) {
            el.textContent = cart.item_count;
            if (cart.item_count > 0) {
              el.style.display = '';
              el.classList.remove('hidden');
            }
          });
        });
        
        // Trigger custom event for theme to listen
        document.dispatchEvent(new CustomEvent('cart:updated', {
          detail: { cart: cart }
        }));
        
        // If theme uses Alpine.js or similar
        if (window.Alpine) {
          window.Alpine.store('cart', cart);
        }
      })
      .catch(function(error) {
        console.error('Error updating cart count:', error);
      });
  }

  // Show Notification
  function showNotification(message, type) {
    // Remove any existing notifications
    const existingNotification = document.querySelector('.cart-notification');
    if (existingNotification) {
      existingNotification.remove();
    }
    
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'cart-notification fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white transition-all transform';
    
    if (type === 'success') {
      notification.classList.add('bg-green-500');
    } else {
      notification.classList.add('bg-red-500');
    }
    
    notification.style.animation = 'slideInRight 0.3s ease-out';
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(function() {
      notification.style.animation = 'slideOutRight 0.3s ease-in';
      setTimeout(function() {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 300);
    }, 3000);
  }

  // Tab Switching
  function switchTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(function(content) {
      content.classList.add('hidden');
    });
    
    // Remove active state from all tabs
    document.querySelectorAll('.tab-btn').forEach(function(btn) {
      btn.classList.remove('text-primary');
      btn.classList.add('text-gray-600');
      const indicator = btn.querySelector('.tab-indicator');
      if (indicator) {
        indicator.remove();
      }
    });
    
    // Show selected tab content
    const selectedTab = document.getElementById('tab-' + tabName);
    if (selectedTab) {
      selectedTab.classList.remove('hidden');
    }
    
    // Add active state to selected tab
    const activeTab = document.querySelector('[data-tab="' + tabName + '"]');
    if (activeTab) {
      activeTab.classList.remove('text-gray-600');
      activeTab.classList.add('text-primary');
      
      // Add indicator
      const indicator = document.createElement('div');
      indicator.className = 'absolute bottom-0 left-0 right-0 h-0.5 bg-primary tab-indicator';
      activeTab.appendChild(indicator);
    }
  }

  // Wishlist Toggle
  function toggleWishlist() {
    const btn = document.getElementById('wishlistBtn');
    if (!btn) return;
    
    const svg = btn.querySelector('svg');
    if (!svg) return;
    
    if (svg.classList.contains('fill-red-500')) {
      svg.classList.remove('fill-red-500');
      btn.classList.remove('bg-red-50', 'border-red-500', 'text-red-500');
      btn.classList.add('border-gray-300', 'text-gray-600');
      showNotification('Removed from wishlist', 'success');
    } else {
      svg.classList.add('fill-red-500');
      btn.classList.remove('border-gray-300', 'text-gray-600');
      btn.classList.add('bg-red-50', 'border-red-500', 'text-red-500');
      showNotification('Added to wishlist', 'success');
    }
  }

  // Share Product
  function shareProduct() {
    if (navigator.share) {
      navigator.share({
        title: document.title,
        url: window.location.href
      })
      .then(function() {
        showNotification('Shared successfully!', 'success');
      })
      .catch(function(err) {
        console.log('Share failed:', err);
      });
    } else {
      // Fallback: copy to clipboard
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(window.location.href)
          .then(function() {
            showNotification('Link copied to clipboard!', 'success');
          })
          .catch(function(err) {
            console.error('Copy failed:', err);
            showNotification('Failed to copy link', 'error');
          });
      } else {
        // Older browsers fallback
        const textArea = document.createElement('textarea');
        textArea.value = window.location.href;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          showNotification('Link copied to clipboard!', 'success');
        } catch (err) {
          console.error('Copy failed:', err);
          showNotification('Failed to copy link', 'error');
        }
        document.body.removeChild(textArea);
      }
    }
  }

  // Make functions globally accessible for inline onclick handlers
  window.changeMainImage = changeMainImage;
  window.changeQuantity = changeQuantity;
  window.updateVariant = updateVariant;
  window.switchTab = switchTab;
  window.toggleWishlist = toggleWishlist;
  window.shareProduct = shareProduct;

  // Initialize on DOM ready
  function initProductPage() {
    // Initialize first thumbnail as active
    const firstThumbnail = document.querySelector('.thumbnail-btn');
    if (firstThumbnail) {
      firstThumbnail.classList.add('border-green-500', 'shadow-lg', 'scale-105');
      firstThumbnail.classList.remove('border-gray-200');
    }

    // Attach Add to Cart event listener
    const addToCartBtn = document.getElementById('addToCart');
    if (addToCartBtn) {
      addToCartBtn.addEventListener('click', addToCart);
    }

    // Attach Quantity Controls event listeners
    const quantityBtns = document.querySelectorAll('[onclick*="changeQuantity"]');
    quantityBtns.forEach(function(btn) {
      btn.removeAttribute('onclick');
      const change = btn.querySelector('svg path[d*="M20 12H4"]') ? -1 : 1;
      btn.addEventListener('click', function() {
        changeQuantity(change);
      });
    });
  }

  // Run initialization
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initProductPage);
  } else {
    initProductPage();
  }

  })();
</script>

<style>
  /* Custom scrollbar for thumbnails */
  .overflow-x-auto::-webkit-scrollbar {
    height: 6px;
  }

  .overflow-x-auto::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
  }

  .overflow-x-auto::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 10px;
  }

  .overflow-x-auto::-webkit-scrollbar-thumb:hover {
    background: #555;
  }

  /* Notification animations */
  @keyframes slideInRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes slideOutRight {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }
</style>