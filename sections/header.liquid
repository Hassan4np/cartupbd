{% stylesheet %}
  .header-social-item svg {
    max-width: 18px;
  }
  .main-header.fixed-top {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 9999;
    transition: transform 0.3s ease-in-out;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.10);
  }
  .header-padding {
    padding-top: var(--header-height, 80px);
  }
  .cart-count-badge {
    min-width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  /* .menu-link::before {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    width: 100%;
    height: 2px;
    background-color: currentColor;
    opacity: 0;
    transition: opacity 0.3s ease;
  } */
  .menu-link.active::before,
  .menu-link:hover::before {
    opacity: 1;
  }
  .quantity-btn {
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #e5e7eb;
    border-radius: 30px;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
  }
  .quantity-btn:hover {
    border-color: #1EB278;
    color: #1EB278;
  }
  .quantity-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  div#cartItems img {
    border: 1px solid #E1E1E1;
    height: 120px;
    object-fit: contain;
    border-radius: 8px !important;
  }
  div#cartItems h3 {
    color: #252624;
    font-size: 22px;
    font-weight: 600;
    line-height: 120%; 
    text-transform: capitalize !important;
  }
  div#cartItems p {
    color: #7F847B;
    font-size: 16px;
    font-weight: 300;
    line-height: 130%;
    max-width: 220px;
    margin-bottom: 15px !important;
  }
  div#cartItems span {
    font-size: 18px;
  }
  div#cartItems .border-b {
    border-color: #E1E1E1;
  }
  button.quantity-btn {
    border-radius: 50%;
    background: #F2F7F4;
  }
  @media(max-width: 767px) {
    div#cartItems h3 {
      font-size: 14px;
    }
    div#cartItems p {
      font-size: 12px;
    }
     div#cartItems img {
    height: 80px;
  }
  .main-header .btn-6 {
    padding: 12px 24px !important;
}
  }
{% endstylesheet %}

<!-- Main Header -->
<header id="header-area" class="main-header bg-[#F8F8F8]  px-0 z-50">
  <div class="container mx-auto px-4">
    <div class="header-inner flex justify-between items-center">
      <!-- Mobile Menu Toggle -->
      <button
        id="menuToggle"
        class="lg:hidden cursor-pointer hover:scale-105 transition-all duration-300 mr-12"
        aria-label="Open Menu"
        aria-expanded="false"
        aria-controls="mobileMenu"
      >
        <svg width="24" height="20" viewBox="0 0 17 13" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M0.75 0.75H15.75M0.75 6.25H15.75M0.75 11.75H15.75" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <!-- Logo Section -->
      <div class="site-logo py-4.5 xl:py-4 px-5!">
        <a href="{{ routes.root_url }}" aria-label="{{ shop.name }}">
          {% if section.settings.logo != blank %}
            <img 
              src="{{ section.settings.logo | image_url }}"
              alt="{{ shop.name }}"
              class="hidden lg:block w-full max-w-18 xl:max-w-40"
              width=""
              height=""
              loading="eager"
            >
            <img 
              src="{{ section.settings.logo | image_url }}"
              alt="{{ shop.name }}"
              class="lg:hidden w-fulll max-w-25"
              width="120"
              height="auto"
              loading="eager"
            >
          {% else %}
            <span class="text-lg lg:text-3xl font-bold font-serif tracking-wide">{{ shop.name }}</span>
          {% endif %}
        </a>
      </div>

      <!-- Desktop Navigation -->
      {% if section.settings.menu != blank %}
        {% assign main_menu = linklists[section.settings.menu] %}
      {% else %}
        {% assign main_menu = linklists['main-menu'] %}
      {% endif %}

      {% if main_menu and main_menu.links.size > 0 %}
        <nav id="desktopMenu" class="hidden lg:flex rounded-sm" role="navigation" aria-label="Main Navigation">
          {% for link in main_menu.links %}
            <a
              href="{{ link.url }}"
              class="menu-link text-base md:text-base xl:text-lg  py-4.5 lg:py-5 px-5! font-semibold leading-normal relative hover:text-secondary transition duration-300"
              {% if link.active %}aria-current="page"{% endif %}
            >
              {{ link.title }}
            </a>
          {% endfor %}
        </nav>
      {% endif %}
      
      <!-- Header Actions -->
      <div class="flex items-center">
        <!-- Search Icon -->
       {% comment %} <button
          id="searchToggle"
          class="cursor-pointer hover:scale-105 transition-all duration-300 py-6 px-5! border-x border-b border-x-[#E9E9E9] border-b-[#E9E9E9]"
          aria-label="Search"
        >
         {%- render 'search-icon' -%}
        </button>  {% endcomment %}

        <!-- Cart Icon with Badge -->
        <button
          id="cartToggle"
          class="relative py-4.5 lg:py-5 px-2! text-base md:text-base xl:text-lg! font-semibold cursor-pointer hover:scale-105 transition-all duration-300"
          aria-label="Shopping Cart"
        >
        cart
          {% comment %} {%- render 'cart-icon' -%} {% endcomment %}
          <span
            id="cart-count"
            class="cart-count-badge absolute top-2.5 right-1 bg-black text-white text-xs rounded-full p-1.5 hidden"
          >0</span>
        </button>

        <!-- Profile Icon -->
        <a
          href="{{ routes.account_url }}"
          class="cursor-pointer py-4.5 lg:py-5 px-2! text-base md:text-base xl:text-lg font-semibold hover:scale-105 transition-all duration-300"
          aria-label="Account"
        >
          {% comment %} {%- render 'profile-icon' -%} {% endcomment %}
           account
        </a>

      </div>
    </div>
  </div>
</header>

<!-- Cart Popup -->
<div
  id="cartPopup"
  class="fixed inset-0 bg-[rgba(0,0,0,0.10)] backdrop-blur-[1px] hidden z-[9999] opacity-0 transition-opacity duration-300"
  role="dialog"
  aria-modal="true"
  aria-label="Shopping Cart">
  <div
    id="cartPanel"
    class="bg-white w-[90%] md:max-w-md lg:max-w-[560px] ml-auto p-4 md:p-8 flex flex-col transform translate-x-full transition-transform duration-300 overflow-y-auto h-[80%] mt-22 xl:mt-35"
  >
    <!-- Cart Header -->
    <div class="flex justify-between items-center mb-3 md:mb-6 pb-3 md:pb-4 border-b border-[#E1E1E1]">
      <div class="flex items-center gap-2">
        {%- render 'cart-icon' -%}
        <h2 class="text-lg lg:text-[22px] text-heading font-light leading-tight -mb-1.5">Cart (<span id="cart-popup-count">0</span>)</h2>
      </div>
      <button 
        id="cartClose" 
        class="text-2xl cursor-pointer hover:rotate-90 transition-all duration-300"
        aria-label="Close Cart"
      >
        ‚úï
      </button>
    </div>
    
    <!-- Cart Items Container -->
    <div id="cartItemsContainer" class="flex-1 overflow-y-auto mb-6">
      <div id="emptyCart" class="text-center py-12 hidden">
        <figure class="flex justify-center">
          {%- render 'empty-cart-icon' -%}
        </figure>
        <p class="text-heading text-base md:text-xl lg:text-[26px] font-semibold leading-[120%] mb-3 mt-15">Your cart is currently empty</p>
        <p class="text-para text-xs lg:text-xl font-light leading-normal mb-5 mx-auto">Explore our products to begin your wellness journey.</p>
        <button onclick="document.getElementById('cartClose').click()" class="btn-6 bg-primary w-full rounded-2xl! text-sm xl:text-xl leading-[160%] text-white! border border-primary! hover:text-wheading! px-6 py-3">
          Continue Shopping
          <span></span>
        </button>
      </div>
      <div id="cartItems"></div>
    </div>

    <!-- Cart Footer -->
    <div id="cartFooter" class="border-t border-[#E1E1E1] pt-4 hidden">
      <div class="flex justify-between items-center">
        <span class="text-base lg:text-[22px] font-light leading-[120%] text-para">Subtotal:</span>
        <span id="cartSubtotal" class="text-base md:text-lg lg:text-[22px] font-semibold text-heading">¬£0.00</span>
      </div>
      <p class="text-[15px] lg:text-[22px] font-light leading-[120%] text-heading mb-3 md:mb-5 mt-3 md:mt-6">
        Estimated Delivery:
        <span class="text-[13px] lg:text-[22px] font-light leading-[120%] text-para block mt-3">UK orders typically arrive in 2‚Äì3 business days.</span>
      </p>
      <a
        href="/checkout"
        class="btn-6 w-full bg-primary mb-3 rounded-lg! md:rounded-2xl! text-base xl:text-xl leading-[160%] text-wheading"
      >
        Proceed to Checkout
        <span></span>
      </a>
      <button
        id="continueShopping"
        class="btn-6 w-full bg-white mb-3 rounded-lg! md:rounded-2xl! text-base xl:text-xl leading-[160%] text-primary! border border-primary! hover:text-wheading!"
        onclick="document.getElementById('cartClose').click()">
        Continue Shopping
        <span></span>
      </button>
    </div>
  </div>
</div>

<!-- Offcanvas Mobile Menu -->
<div
  id="mobileMenu"
  class="fixed inset-0 bg-black/50 left-0 top-0 hidden z-999998 opacity-0 transition-opacity duration-300"
  role="dialog"
  aria-modal="true"
  aria-label="Mobile Navigation"
>
  <div
    id="mobileMenuPanel"
    class="bg-white w-64 h-full p-6 flex flex-col transform -translate-x-full transition-transform duration-300"
    role="navigation"
  >
    <div class="flex justify-between items-center mb-6">
      <div class="site-logo">
        <a href="{{ routes.root_url }}" aria-label="{{ shop.name }}">
          {% if section.settings.logo != blank %}
            <img 
              src="{{ section.settings.logo | image_url: width: 150 }}" 
              alt="{{ shop.name }}" 
              class="max-w-18 xl: h-auto"
              width="150"
              height="auto"
            >
          {% else %}
            <span class="text-base font-bold font-serif tracking-wide">{{ shop.name }}</span>
          {% endif %}
        </a>
      </div>
      <button 
        id="menuClose" 
        class="text-2xl cursor-pointer hover:scale-105 transition-all duration-300"
        aria-label="Close Menu"
      >
        ‚úï
      </button>
    </div>
    
    {% if main_menu and main_menu.links.size > 0 %}
      <nav class="flex flex-col">
        {% for link in main_menu.links %}
          <a 
            href="{{ link.url }}" 
            class="block py-4 text-lg border-b hover:text-[#1EB278] transition-all duration-300"
            {% if link.active %}aria-current="page"{% endif %}
          >
            {{ link.title }}
          </a>
        {% endfor %}
      </nav>
    {% endif %}
  </div>
</div>

{% schema %}
{
  "name": "Header",
  "settings": [
    {
      "type": "link_list",
      "id": "menu",
      "label": "Navigation Menu",
      "default": "main-menu"
    },
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo"
    },
    {
      "type": "range",
      "id": "logo_width",
      "min": 100,
      "max": 300,
      "step": 10,
      "unit": "px",
      "label": "Logo Width",
      "default": 180
    }
  ]
}
{% endschema %}

<script>
document.addEventListener('DOMContentLoaded', function () {
  console.log('üöÄ Header cart system initializing...');
  
  // ========================================
  // MOBILE MENU TOGGLE
  // ========================================
  const menuToggle = document.getElementById('menuToggle');
  const mobileMenu = document.getElementById('mobileMenu');
  const menuPanel = document.getElementById('mobileMenuPanel');
  const menuClose = document.getElementById('menuClose');

  function openMenu() {
    mobileMenu.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    menuToggle.setAttribute('aria-expanded', 'true');
    setTimeout(() => {
      mobileMenu.classList.remove('opacity-0');
      menuPanel.classList.remove('-translate-x-full');
    }, 20);
  }

  function closeMenu() {
    mobileMenu.classList.add('opacity-0');
    menuPanel.classList.add('-translate-x-full');
    document.body.style.overflow = '';
    menuToggle.setAttribute('aria-expanded', 'false');
    setTimeout(() => {
      mobileMenu.classList.add('hidden');
    }, 300);
  }

  if (menuToggle) menuToggle.addEventListener('click', openMenu);
  if (menuClose) menuClose.addEventListener('click', closeMenu);
  if (mobileMenu) {
    mobileMenu.addEventListener('click', (e) => {
      if (e.target === mobileMenu) closeMenu();
    });
  }

  // ========================================
  // CART POPUP TOGGLE
  // ========================================
  const cartToggle = document.getElementById('cartToggle');
  const cartPopup = document.getElementById('cartPopup');
  const cartPanel = document.getElementById('cartPanel');
  const cartClose = document.getElementById('cartClose');
  const continueShopping = document.getElementById('continueShopping');

  function openCart() {
    console.log('üõí Opening cart...');
    cartPopup.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    setTimeout(() => {
      cartPopup.classList.remove('opacity-0');
      cartPanel.classList.remove('translate-x-full');
    }, 20);
    updateCartDisplay();
  }

  function closeCart() {
    console.log('‚ùå Closing cart...');
    cartPopup.classList.add('opacity-0');
    cartPanel.classList.add('translate-x-full');
    document.body.style.overflow = '';
    setTimeout(() => {
      cartPopup.classList.add('hidden');
    }, 300);
  }

  if (cartToggle) cartToggle.addEventListener('click', openCart);
  if (cartClose) cartClose.addEventListener('click', closeCart);
  if (continueShopping) continueShopping.addEventListener('click', closeCart);
  if (cartPopup) {
    cartPopup.addEventListener('click', (e) => {
      if (e.target === cartPopup) closeCart();
    });
  }

  // ========================================
  // ESC KEY TO CLOSE MENUS
  // ========================================
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (!mobileMenu.classList.contains('hidden')) closeMenu();
      if (!cartPopup.classList.contains('hidden')) closeCart();
    }
  });

  // ========================================
  // DESKTOP ACTIVE MENU HIGHLIGHT
  // ========================================
  const links = document.querySelectorAll('#desktopMenu .menu-link');
  const currentPath = window.location.pathname.replace(/\/$/, '');
  links.forEach((link) => {
    const linkPath = link.getAttribute('href').replace(/\/$/, '');
    if (currentPath === linkPath || (currentPath === '' && linkPath === '/')) {
      link.classList.add('active');
    }
  });

  // ========================================
  // STICKY HEADER WITH SCROLL
  // ========================================
  const header = document.getElementById('header-area');
  if (header) {
    const headerHeight = header.offsetHeight;
    let lastScroll = 0;

    document.documentElement.style.setProperty('--header-height', headerHeight + 'px');

    function throttle(func, limit) {
      let inThrottle;
      return function () {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
          func.apply(context, args);
          inThrottle = true;
          setTimeout(() => (inThrottle = false), limit);
        }
      };
    }

    const handleScroll = throttle(function () {
      const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
      if (currentScroll < 0) return;

      if (currentScroll > headerHeight) {
        if (!header.classList.contains('fixed-top')) {
          header.classList.add('fixed-top');
          document.body.classList.add('header-padding');
        }

        if (currentScroll > lastScroll && currentScroll > headerHeight * 2) {
          header.style.transform = 'translateY(-100%)';
        } else {
          header.style.transform = 'translateY(0)';
        }
      } else {
        if (header.classList.contains('fixed-top')) {
          header.classList.remove('fixed-top');
          document.body.classList.remove('header-padding');
          header.style.transform = 'translateY(0)';
        }
      }

      lastScroll = currentScroll;
    }, 10);

    window.addEventListener('scroll', handleScroll, { passive: true });

    window.addEventListener('resize', throttle(function () {
      const newHeaderHeight = header.offsetHeight;
      document.documentElement.style.setProperty('--header-height', newHeaderHeight + 'px');
    }, 100));
  }

  // ========================================
  // CART FUNCTIONS - ‚úÖ FIXED VERSION
  // ========================================
  
  function updateCartCount() {
    fetch('/cart.js')
      .then(response => response.json())
      .then(cart => {
        const cartCountEl = document.getElementById('cart-count');
        const cartPopupCountEl = document.getElementById('cart-popup-count');
        
        // Count actual items (excluding free items with ¬£0)
        const actualItemCount = cart.items.filter(item => {
          return !(item.final_line_price === 0 && item.properties && 
                  (item.properties._free_items || item.properties._promotion));
        }).reduce((sum, item) => sum + item.quantity, 0);
        
        if (cartCountEl) {
          cartCountEl.textContent = actualItemCount;
          if (actualItemCount > 0) {
            cartCountEl.classList.remove('hidden');
          } else {
            cartCountEl.classList.add('hidden');
          }
        }
        
        if (cartPopupCountEl) {
          cartPopupCountEl.textContent = actualItemCount;
        }
        
        console.log('üî¢ Actual cart count:', actualItemCount, '(Total items:', cart.item_count + ')');
      })
      .catch(err => console.error('‚ùå Cart count error:', err));
  }

  function updateCartDisplay() {
    console.log('üîÑ Fetching cart data...');
    
    fetch('/cart.js')
      .then(response => response.json())
      .then(cart => {
        const cartItemsEl = document.getElementById('cartItems');
        const emptyCartEl = document.getElementById('emptyCart');
        const cartFooterEl = document.getElementById('cartFooter');
        const cartSubtotalEl = document.getElementById('cartSubtotal');
        
        console.log('üõí Full cart data:', cart);
        
        // ‚úÖ Filter out FREE items (¬£0 with promotion properties)
        const visibleItems = cart.items.filter(item => {
          const isFreeItem = item.final_line_price === 0 && 
                           item.properties && 
                           (item.properties._free_items || item.properties._promotion);
          
          if (isFreeItem) {
            console.log('üéÅ Hiding free item:', item.product_title, '(qty:', item.quantity + ')');
          }
          
          return !isFreeItem;
        });
        
        console.log('üëÄ Visible items:', visibleItems.length, '/', cart.items.length);
        
        if (visibleItems.length === 0) {
          emptyCartEl.classList.remove('hidden');
          cartFooterEl.classList.add('hidden');
          cartItemsEl.innerHTML = '';
          console.log('üì¶ Cart is empty');
        } else {
          emptyCartEl.classList.add('hidden');
          cartFooterEl.classList.remove('hidden');
          
          // ‚úÖ Group items by product to detect offers
          const groupedByProduct = {};
          cart.items.forEach(item => {
            const key = item.product_id;
            if (!groupedByProduct[key]) {
              groupedByProduct[key] = [];
            }
            groupedByProduct[key].push(item);
          });
          
          // ‚úÖ Display ONLY visible items (paid items)
          cartItemsEl.innerHTML = visibleItems.map((item, visualIndex) => {
            const actualIndex = cart.items.findIndex(i => i.key === item.key);
            
            // Check if item is a subscription
            const isSubscription = item.selling_plan_allocation !== null && 
                                  item.selling_plan_allocation !== undefined;
            
            // ‚úÖ Check if THIS product has an active "Buy X Get Y Free" offer
            const productGroup = groupedByProduct[item.product_id] || [];
            const hasFreeItemsInGroup = productGroup.some(i => 
              i.final_line_price === 0 && 
              i.properties && 
              (i.properties._free_items || i.properties._promotion)
            );
            
            const freeItemsCount = hasFreeItemsInGroup 
              ? productGroup.filter(i => 
                  i.final_line_price === 0 && 
                  i.properties && 
                  (i.properties._free_items || i.properties._promotion)
                ).reduce((sum, i) => sum + i.quantity, 0)
              : 0;
            
            // Use Shopify's actual line price
            const displayPrice = item.final_line_price / 100;
            const originalPrice = item.original_line_price / 100;
            
            // Only show strikethrough if there's an actual price difference
            const hasActualDiscount = originalPrice > displayPrice;
            
            console.log(`Item ${visualIndex + 1}:`, {
              title: item.product_title,
              quantity: item.quantity,
              displayPrice: displayPrice,
              originalPrice: originalPrice,
              hasDiscount: hasActualDiscount,
              hasFreeItems: hasFreeItemsInGroup,
              freeCount: freeItemsCount
            });
            
            return `
              <div class="flex gap-3 md:gap-5 py-2.5 md:py-5 border-b border-[#E1E1E1]" data-line="${actualIndex + 1}">
                <img 
                  src="${item.featured_image ? item.featured_image.url : item.image}" 
                  alt="${item.product_title}" 
                  class="w-20 md:w-28 lg:w-30 h-20 md:h-28 lg:h-30 object-contain rounded-lg border border-[#E1E1E1] bg-white flex-shrink-0" 
                />
                <div class="flex flex-col justify-between flex-1 min-w-0">
                  <div>
                    <h3 class="text-sm md:text-base lg:text-[22px] font-semibold text-heading leading-tight mb-1 md:mb-2 capitalize">${item.product_title}</h3>
                    ${item.variant_title && item.variant_title !== 'Default Title' ? `
                      <p class="text-xs md:text-sm lg:text-base text-para font-light leading-normal mb-2 md:mb-3 max-w-[220px]">${item.variant_title}</p>
                    ` : ''}
                    ${isSubscription ? `
                      <p class="text-xs text-primary font-medium">üîÑ Subscription</p>
                    ` : ''}
                    ${hasFreeItemsInGroup && !isSubscription ? `
                      <p class="text-xs text-primary font-medium">üéâ Buy 2, Get 1 Free Applied (+${freeItemsCount} FREE)</p>
                    ` : ''}
                  </div>
                  <div class="flex items-center gap-2 md:gap-3 mt-2">
                    <button 
                      class="quantity-btn w-7 h-7 md:w-9 md:h-9 flex items-center justify-center rounded-full bg-[#F2F7F4] border border-[#E1E1E1] text-heading hover:border-primary hover:text-primary transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed text-base md:text-lg font-medium" 
                      data-line="${actualIndex + 1}" 
                      data-qty="${item.quantity}" 
                      data-action="decrease" 
                      ${item.quantity <= 1 ? 'disabled' : ''}
                    >‚àí</button>
                    <span class="text-sm md:text-base lg:text-lg text-heading font-medium min-w-[30px] text-center">${String(item.quantity).padStart(2, '0')}</span>
                    <button 
                      class="quantity-btn w-7 h-7 md:w-9 md:h-9 flex items-center justify-center rounded-full bg-[#F2F7F4] border border-[#E1E1E1] text-heading hover:border-primary hover:text-primary transition-all duration-300 text-base md:text-lg font-medium" 
                      data-line="${actualIndex + 1}" 
                      data-qty="${item.quantity}" 
                      data-action="increase"
                    >+</button>
                  </div>
                </div>
                <div class="text-right flex flex-col justify-between items-end flex-shrink-0">
                  ${hasActualDiscount ? `
                    <div>
                      <p class="text-xs text-para line-through opacity-60 mb-1">¬£${originalPrice.toFixed(2)}</p>
                      <p class="font-semibold text-sm md:text-lg lg:text-[22px] text-primary leading-tight">
                        ¬£${displayPrice.toFixed(2)}
                      </p>
                    </div>
                  ` : `
                    <p class="font-semibold text-sm md:text-lg lg:text-[22px] text-heading leading-tight">
                      ¬£${displayPrice.toFixed(2)}
                    </p>
                  `}
                  <button 
                    class="text-xs md:text-sm lg:text-base cursor-pointer text-para hover:text-red-600 font-medium leading-tight transition-all duration-300 mt-2" 
                    data-remove="${actualIndex + 1}"
                  >Remove</button>
                </div>
              </div>
            `;
          }).join('');
          
          // ‚úÖ Use Shopify's total_price (includes all discounts)
          const totalPrice = cart.total_price / 100;
          console.log('üíµ Subtotal: ¬£' + totalPrice.toFixed(2));
          
          cartSubtotalEl.textContent = `¬£${totalPrice.toFixed(2)}`;
          
          // Add event listeners for quantity buttons
          document.querySelectorAll('.quantity-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const line = parseInt(this.dataset.line);
              const currentQty = parseInt(this.dataset.qty);
              const action = this.dataset.action;
              
              const newQty = action === 'increase' ? currentQty + 1 : Math.max(1, currentQty - 1);
              updateCartQuantity(line, newQty);
            });
          });

          // Add event listeners for remove buttons
          document.querySelectorAll('[data-remove]').forEach(btn => {
            btn.addEventListener('click', function() {
              const line = parseInt(this.dataset.remove);
              removeFromCart(line);
            });
          });
        }
        
        updateCartCount();
      })
      .catch(err => console.error('‚ùå Cart display error:', err));
  }

  function updateCartQuantity(line, quantity) {
    document.querySelectorAll('.quantity-btn').forEach(btn => btn.disabled = true);
    
    console.log(`üîÑ Updating line ${line} to qty ${quantity}`);
    
    fetch('/cart/change.js', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ 
        line: line,
        quantity: quantity 
      })
    })
    .then(response => response.json())
    .then(() => {
      console.log('‚úÖ Quantity updated');
      updateCartDisplay();
      document.dispatchEvent(new CustomEvent('cart:updated'));
    })
    .catch(err => {
      console.error('‚ùå Quantity update error:', err);
      updateCartDisplay();
    });
  }

  function removeFromCart(line) {
    const confirmBox = confirm('Are you sure you want to remove this item from cart?');
    
    if (confirmBox) {
      const removeBtn = document.querySelector(`[data-remove="${line}"]`);
      if (removeBtn) {
        removeBtn.textContent = 'Removing...';
        removeBtn.disabled = true;
      }
      
      console.log(`üóëÔ∏è Removing line ${line}`);
      
      fetch('/cart/change.js', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({ 
          line: line,
          quantity: 0 
        })
      })
      .then(response => response.json())
      .then(() => {
        console.log('‚úÖ Item removed');
        updateCartDisplay();
        document.dispatchEvent(new CustomEvent('cart:updated'));
      })
      .catch(err => {
        console.error('‚ùå Remove error:', err);
        alert('Failed to remove item. Please try again.');
        updateCartDisplay();
      });
    }
  }

  // Make functions globally accessible
  window.removeFromCart = removeFromCart;
  window.updateCartCount = updateCartCount;
  window.updateCartDisplay = updateCartDisplay;
  window.openCartPopup = openCart;

  // Listen for cart updates
  document.addEventListener('cart:updated', function() {
    console.log('üì£ Cart updated event');
    updateCartCount();
    updateCartDisplay();
  });

  document.addEventListener('product:added-to-cart', function() {
    console.log('üì£ Product added event');
    updateCartCount();
    updateCartDisplay();
  });

  // Initial load
  updateCartCount();
  console.log('‚úÖ Cart system ready');
});
</script>