<div class="product-all py-10 md:py-14 lg:py-20 xl:py-25" x-data="productFilter()">
  <div class="container font-poppins">
    <div class="flex items-start gap-5 lg:gap-6">
      <!-- Filtering Area -->
      <div class="w-full md:w-3/12">
        <div class="filtering-area border border-border rounded-md p-4 lg:p-5">
          
          <!-- Category Filter -->
          <div class="product-category-area mb-4 lg:mb-5">
            <h3 class="text-subheading font-poppins! capitalize text-base md:text-lg pb-2 lg:pb-3 border-b border-b-border mb-4 lg:mb-5">Product Category</h3>
            <ul>
              <li class="mb-3 lg:mb-4">
                <a @click="selectCategory('all')" 
                   :class="selectedCategory === 'all' ? 'text-secondary' : 'text-gray hover:text-secondary'" 
                   class="category-list text-sm md:text-base font-medium duration-300 cursor-pointer flex items-center justify-between gap-1 w-full">
                  <span class="category-name">All Products</span>
                  <span class="all-item">[{{ collections.all.products_count }}]</span>
                </a>
              </li>
              {% for collection in collections %}
                {% if collection.products_count > 0 %}
                <li class="mb-3 lg:mb-4 last:mb-0">
                  <a @click="selectCategory('{{ collection.handle }}')" 
                     :class="selectedCategory === '{{ collection.handle }}' ? 'text-secondary' : 'text-gray hover:text-secondary'" 
                     class="category-list text-sm md:text-base font-medium duration-300 cursor-pointer flex items-center justify-between gap-1 w-full">
                    <span class="category-name">{{ collection.title }}</span>
                    <span class="all-item">[{{ collection.products_count }}]</span>
                  </a>
                </li>
                {% endif %}
              {% endfor %}
            </ul>
          </div>

          <!-- Price Filter -->
          <div class="product-price-filter mb-4 lg:mb-5">
            <h3 class="text-subheading font-poppins! capitalize text-base md:text-lg pb-2 lg:pb-3 border-b border-b-border mb-4 lg:mb-5">Filter By Price</h3>
            <div class="relative z-1 mb-4 lg:mb-5">
              <input type="range" x-model.number="minPrice" min="0" max="500" step="10" 
                     class="absolute w-full h-1.5 appearance-none bg-transparent pointer-events-auto z-10"
                     style="background: none;">
              <input type="range" x-model.number="maxPrice" min="0" max="500" step="10"
                     class="absolute w-full h-1.5 appearance-none bg-transparent pointer-events-auto z-10"
                     style="background: none;">
              <div class="bg-border h-1.5 w-full rounded-full relative">
                <div class="h-full bg-primary rounded-full absolute" 
                     :style="`left: ${(minPrice/500)*100}%; width: ${((maxPrice-minPrice)/500)*100}%`"></div>
              </div>
            </div>
            <h3 class="text-subheading font-poppins! capitalize text-base md:text-lg">
              Price: <span class="text-gray" x-text="`$${minPrice} - $${maxPrice}`"></span>
            </h3>
            <button @click="applyPriceFilter()" class="btn mt-4 lg:mt-5 w-full">Filter</button>
          </div>

          <!-- Tags Filter -->
          <div class="product-tags">
            <h3 class="text-subheading font-poppins! capitalize text-base md:text-lg pb-2 lg:pb-3 border-b border-b-border mb-4 lg:mb-5">Product Tags</h3>
            <div class="flex items-center gap-2.5 flex-wrap">
              {% assign all_tags = '' | split: '' %}
              {% for product in collections.all.products %}
                {% for tag in product.tags %}
                  {% unless all_tags contains tag %}
                    {% assign all_tags = all_tags | push: tag %}
                  {% endunless %}
                {% endfor %}
              {% endfor %}
              
              {% for tag in all_tags %}
                <button @click="toggleTag('{{ tag | handleize }}')"
                        :class="selectedTags.includes('{{ tag | handleize }}') ? 'bg-primary text-white border-primary' : 'text-gray border-border hover:border-primary'"
                        class="text-sm md:text-base cursor-pointer border rounded-md py-1.5 px-4 duration-300">
                  {{ tag }}
                </button>
              {% endfor %}
            </div>
          </div>

          <!-- Reset Filter -->
          <button @click="resetFilters()" class="btn btn-outline w-full mt-4 lg:mt-5">Reset Filters</button>
        </div>
      </div>

      <!-- Product Display Area -->
      <div class="product-all-area w-full md:w-9/12">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-5 xl:gap-6">
          {% for product in collections.all.products %}
            <div class="product-item" 
                 data-category="{% for collection in product.collections %}{{ collection.handle }} {% endfor %}"
                 data-price="{{ product.price | money_without_currency | remove: ',' }}"
                 data-tags="{% for tag in product.tags %}{{ tag | handleize }} {% endfor %}"
                 x-show="filterProduct($el)"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform scale-95"
                 x-transition:enter-end="opacity-100 transform scale-100">
              
              <div class="flex flex-col justify-between border border-border rounded-md overflow-hidden hover:shadow-lg duration-300">
                <div class="product-image relative overflow-hidden">
                  <a href="{{ product.url }}" class="block">
                    {% if product.featured_image %}
                      <img src="{{ product.featured_image | img_url: 'medium' }}" 
                           alt="{{ product.title }}" 
                           width=""
                           height=""
                           class="w-full h-64 object-cover">
                    {% else %}
                      {{ 'product-1' | placeholder_svg_tag: 'w-full h-64' }}
                    {% endif %}
                  </a>
                </div>
                
                <div class="p-4">
                  <p class="text-sm lg:text-base text-gray mb-2 category">
                    {% if product.collections.first %}
                      {{ product.collections.first.title }}
                    {% else %}
                      Uncategorized
                    {% endif %}
                  </p>
                  
                  {% if product.metafields.reviews.rating.value %}
                    <div class="flex items-center gap-10 lg:gap-12 mb-1.5">
                      <div class="flex items-center gap-1">
                        {% for i in (1..5) %}
                          <svg class="size-3 {% if i <= product.metafields.reviews.rating.value %}text-yellow-400{% else %}text-gray-300{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                          </svg>
                        {% endfor %}
                      </div>
                      <p class="review-count text-sm md:text-base text-gray">({{ product.metafields.reviews.rating_count.value | default: 0 }})</p>
                    </div>
                  {% endif %}
                  
                  <a href="{{ product.url }}">
                    <h3 class="text-base md:text-lg font-medium font-poppins! line-clamp-2 text-subheading mb-2 hover:text-primary duration-300">{{ product.title }}</h3>
                  </a>
                  
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 font-poppins!">
                      <span class="text-primary text-base md:text-lg font-semibold">{{ product.price | money }}</span>
                      {% if product.compare_at_price > product.price %}
                        <span class="text-gray line-through text-sm md:text-base font-medium">{{ product.compare_at_price | money }}</span>
                      {% endif %}
                    </div>
                    
                    <button class="btn add-card-btn flex items-center gap-0.5" 
                            onclick="addToCart({{ product.variants.first.id }}, this)"
                            type="button">
                      <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_8336_522)">
                          <path d="M14 1.72667H2.47333V1.54C2.41111 1.10444 2.21667 0.738889 1.89 0.443334C1.56333 0.147778 1.16667 0 0.7 0H0V1.16667H0.7C0.855556 1.16667 0.987778 1.21333 1.09667 1.30667C1.20556 1.4 1.27556 1.52444 1.30667 1.68L2.24 9.52C2.27111 9.98667 2.45 10.36 2.77667 10.64C3.10333 10.92 3.5 11.0756 3.96667 11.1067H11.6667V9.89333H3.96667C3.81111 9.89333 3.67889 9.84667 3.57 9.75333C3.46111 9.66 3.39111 9.53556 3.36 9.38L3.31333 8.72667H12.74L14 1.72667ZM11.76 7.56H3.17333L2.61333 2.89333H12.6L11.76 7.56ZM2.94 12.8333C2.90889 13.1444 3.01 13.4167 3.24333 13.65C3.47667 13.8833 3.75667 14 4.08333 14C4.41 14 4.68222 13.8833 4.9 13.65C5.11778 13.4167 5.23444 13.1444 5.25 12.8333C5.26556 12.5222 5.15667 12.25 4.92333 12.0167C4.69 11.7833 4.41 11.6667 4.08333 11.6667C3.75667 11.6667 3.48444 11.7833 3.26667 12.0167C3.04889 12.25 2.94 12.5222 2.94 12.8333ZM8.77333 12.8333C8.74222 13.1444 8.84333 13.4167 9.07667 13.65C9.31 13.8833 9.59 14 9.91667 14C10.2433 14 10.5156 13.8833 10.7333 13.65C10.9511 13.4167 11.0678 13.1444 11.0833 12.8333C11.0989 12.5222 10.99 12.25 10.7567 12.0167C10.5233 11.7833 10.2433 11.6667 9.91667 11.6667C9.59 11.6667 9.31778 11.7833 9.1 12.0167C8.88222 12.25 8.77333 12.5222 8.77333 12.8333Z" fill="white"/>
                        </g>
                      </svg>
                      Add
                    </button>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>

        <!-- No Products Found -->
        <div x-show="!hasVisibleProducts()" class="text-center py-10">
          <p class="text-gray text-lg">No products found matching your filters.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function productFilter() {
  return {
    selectedCategory: 'all',
    selectedTags: [],
    minPrice: 0,
    maxPrice: 500,
    priceFilterActive: false,
    
    selectCategory(category) {
      this.selectedCategory = category;
      this.updateProducts();
    },
    
    toggleTag(tag) {
      const index = this.selectedTags.indexOf(tag);
      if (index > -1) {
        this.selectedTags.splice(index, 1);
      } else {
        this.selectedTags.push(tag);
      }
      this.updateProducts();
    },
    
    applyPriceFilter() {
      this.priceFilterActive = true;
      this.updateProducts();
    },
    
    resetFilters() {
      this.selectedCategory = 'all';
      this.selectedTags = [];
      this.minPrice = 0;
      this.maxPrice = 500;
      this.priceFilterActive = false;
      this.updateProducts();
    },
    
    filterProduct(element) {
      const categories = element.dataset.category.trim().split(' ').filter(c => c);
      const price = parseFloat(element.dataset.price);
      const tags = element.dataset.tags.trim().split(' ').filter(t => t);
      
      // Category filter
      if (this.selectedCategory !== 'all' && !categories.includes(this.selectedCategory)) {
        return false;
      }
      
      // Price filter
      if (this.priceFilterActive && (price < this.minPrice || price > this.maxPrice)) {
        return false;
      }
      
      // Tags filter
      if (this.selectedTags.length > 0) {
        const hasTag = this.selectedTags.some(tag => tags.includes(tag));
        if (!hasTag) return false;
      }
      
      return true;
    },
    
    hasVisibleProducts() {
      const products = document.querySelectorAll('.product-item');
      return Array.from(products).some(product => this.filterProduct(product));
    },
    
    updateProducts() {
      // Force Alpine to re-evaluate x-show directives
      this.$nextTick(() => {});
    }
  }
}

// Add to Cart Function
function addToCart(variantId, button) {
  // Button loading state
  const originalText = button.innerHTML;
  button.disabled = true;
  button.innerHTML = '<span>Adding...</span>';
  
  fetch('/cart/add.js', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    },
    body: JSON.stringify({
      id: variantId,
      quantity: 1
    })
  })
  .then(response => response.json())
  .then(data => {
    // Success - Update cart count if you have one
    if (typeof updateCartCount === 'function') {
      updateCartCount();
    }
    
    // Show success message
    button.innerHTML = '<span>âœ“ Added</span>';
    button.classList.add('bg-green-600');
    
    // Reset button after 2 seconds
    setTimeout(() => {
      button.innerHTML = originalText;
      button.disabled = false;
      button.classList.remove('bg-green-600');
    }, 2000);
    
    // Trigger cart drawer if you have one
    if (typeof openCartDrawer === 'function') {
      openCartDrawer();
    }
  })
  .catch(error => {
    console.error('Error adding to cart:', error);
    button.innerHTML = '<span>Error!</span>';
    button.classList.add('bg-red-600');
    
    setTimeout(() => {
      button.innerHTML = originalText;
      button.disabled = false;
      button.classList.remove('bg-red-600');
    }, 2000);
  });
}
</script>

<style>
input[type="range"] {
  -webkit-appearance: none;
  width: 100%;
  height: 6px;
  outline: none;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: var(--primary-color, #10b981);
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

input[type="range"]::-moz-range-thumb {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: var(--primary-color, #10b981);
  cursor: pointer;
  border: none;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
</style>